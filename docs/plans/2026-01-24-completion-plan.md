# 还我一个土木梦 - 完成计划

> **基于当前项目状态的新执行计划**
>
> **创建时间**: 2026-01-24
> **当前状态**: 前后端核心功能已完成，需要集成、测试和优化

---

## 当前项目状态评估

### ✅ 已完成功能

**前端** (Phase 1-5):
- ✅ React + Vite + TypeScript 项目初始化
- ✅ 路由系统（React Router）：/, /game, /result, /leaderboard
- ✅ 共享类型定义（@shared/types）
- ✅ 游戏状态管理（Zustand store）
- ✅ 60 张事件卡数据（涵盖项目全生命周期）
- ✅ UI 组件：StatusBar、EventCard（飞书风格）
- ✅ 4 个页面：Home、Game、Result、Leaderboard
- ✅ UI 重设计：飞书风格 + 土木工程主题

**后端** (Phase 7):
- ✅ Express + TypeScript 服务器
- ✅ SQLite 数据库（3 张表：runs, leaderboard, game_stats）
- ✅ 游戏会话 API（/api/run/start, /api/run/finish）
- ✅ 排行榜 API（/api/leaderboard, /api/leaderboard/me, /api/leaderboard/stats）
- ✅ 安全中间件（签名验证、限流、异常值检测）
- ✅ 开发服务器运行中 (localhost:3001)

**联调** (Task 3):
- ✅ 前端 API 客户端（gameApi.ts, llmApi.ts）
- ✅ gameStore 集成后端 API
- ✅ 游戏成绩自动上传功能
- ✅ 离线模式支持

### ⚠️ 待完成功能

1. **排行榜数据集成** - Leaderboard.tsx 使用 Mock 数据，需对接后端 API
2. **移动端适配测试** - 响应式布局需要真机测试
3. **完整游戏流程测试** - 端到端验证所有功能
4. **性能优化** - 首屏加载、动画性能
5. **Bug 修复** - 后端 UNIQUE 约束错误等

---

## 执行计划

### Batch 1: 排行榜数据集成（优先级：高）

**目标**: 让排行榜页面显示真实的后端数据

#### Task 1.1: 更新 Leaderboard 页面

**文件**: `frontend/src/pages/Leaderboard.tsx`

**步骤**:

1. **创建排行榜 Store**（如果需要单独管理排行榜状态）

   或直接在组件中使用 useState 管理状态

2. **集成后端 API**:
   ```typescript
   import { getLeaderboard, getMyRank, getGlobalStats } from '@/api';
   import { useEffect, useState } from 'react';
   ```

3. **实现数据获取**:
   - 组件挂载时调用 `getLeaderboard()`
   - 支持 3 种类型切换：overall, cash, games
   - 实现分页加载（limit, offset）

4. **显示玩家排名**:
   - 调用 `getMyRank()` 获取当前玩家排名
   - 显示在页面顶部或底部

5. **显示全局统计**:
   - 调用 `getGlobalStats()` 获取总玩家数、平均分等
   - 显示在排行榜顶部

6. **错误处理**:
   - API 失败时显示降级 UI（"暂时无法连接服务器"）
   - 使用加载骨架屏

**验证**:
- [ ] 访问 /leaderboard 能看到真实数据
- [ ] Tab 切换能正常工作（综合榜/现金榜/游戏次数榜）
- [ ] 显示当前玩家排名（或"暂无排名"）
- [ ] API 失败时有友好提示

---

#### Task 1.2: 修复后端 UNIQUE 约束错误

**文件**: `backend/src/api/run.ts`

**问题描述**:
```
SQLITE_CONSTRAINT: UNIQUE constraint failed: leaderboard.deviceId
```

**原因分析**:
- 同一个 deviceId 的记录已存在
- INSERT 操作冲突，应该使用 UPDATE

**修复方案**:

在 `backend/src/api/run.ts` 的 `POST /api/run/finish` 中：

**当前代码** (第 133-156 行):
```typescript
// 更新排行榜
const existingLeaderboard = await db.get(
  'SELECT * FROM leaderboard WHERE deviceId = ?',
  [deviceId]
);

if (existingLeaderboard) {
  // 更新现有记录
  const newBestScore = Math.max(existingLeaderboard.bestScore, score);
  await db.run(
    `UPDATE leaderboard
     SET bestScore = ?, totalGames = totalGames + 1,
         totalCash = totalCash + ?, updatedAt = CURRENT_TIMESTAMP
     WHERE deviceId = ?`,
    [newBestScore, stats.cash || 0, deviceId]
  );
} else {
  // 新建排行榜记录
  await db.run(
    `INSERT INTO leaderboard (deviceId, bestScore, totalGames, totalCash)
     VALUES (?, ?, ?, ?)`,
    [deviceId, score, 1, stats.cash || 0]
  );
}
```

**问题**: 可能是之前测试时已经插入了记录，后续更新逻辑有问题。

**修复**:
1. 检查是否 deviceId 传递正确
2. 确保 UPDATE 语句的 SET 部分正确
3. 添加日志调试

**验证**:
- [ ] 多次完成游戏，不再报 UNIQUE 约束错误
- [ ] 排行榜数据正确更新（bestScore 取最大值）
- [ ] totalGames 正确累加

---

### Batch 2: 移动端适配和优化

#### Task 2.1: 移动端响应式测试

**目标**: 确保在手机上有良好的游戏体验

**测试清单**:

1. **iPhone SE (375x667)**:
   - [ ] 首页按钮大小适合点击
   - [ ] 游戏页面：状态栏和事件卡布局合理
   - [ ] 结算页面：数据清晰可读
   - [ ] 排行榜：列表项不拥挤

2. **iPhone 12 Pro (390x844)**:
   - [ ] 同上测试项

3. **Android 常见分辨率**:
   - [ ] 360x640
   - [ ] 411x731

**适配要点**:

**首页** (`Home.tsx`):
- 按钮最小高度 44px（iOS 人手点击区域）
- 文字大小不小于 14px
- 卡片间距合理

**游戏页** (`Game.tsx`):
- 状态栏可以考虑固定在顶部或底部
- 事件卡选项按钮间距足够
- 返回按钮容易点击

**结算页** (`Result.tsx`):
- 数据卡片布局可以改为单列
- 按钮组可以考虑底部固定

**排行榜** (`Leaderboard.tsx`):
- 列表项高度适中
- Tab 切换容易操作

**工具**:
- Chrome DevTools 设备模拟器
- 真机测试（可选）

**验证**:
- [ ] 在 375px 宽度下无布局问题
- [ ] 横屏时有合理的提示或限制
- [ ] 所有交互元素可点击
- [ ] 文字清晰可读

---

#### Task 2.2: 触摸优化

**目标**: 提升移动端交互体验

**优化项**:

1. **移除 hover 依赖**:
   - CSS 中的 `:hover` 在移动端无效
   - 关键信息不要只依赖 hover 显示

2. **添加触摸反馈**:
   - 选项按钮点击时有 `:active` 缩放效果（已有）
   - 可以添加触摸涟漪效果（可选）

3. **防止双击缩放**:
   - 确保 `user-scalable=no` 在 index.html 中
   - 或添加 touch-action CSS

4. **iOS 橡皮筋效果优化**:
   - 已禁用缩放
   - 考虑固定顶部导航

**验证**:
- [ ] 点击选项无延迟
- [ ] 无意外缩放
- [ ] 滚动流畅

---

### Batch 3: 完整游戏流程测试

#### Task 3.1: 端到端功能验证

**测试场景**:

**场景 1: 正常通关**
1. 开始游戏 → 进入游戏页
2. 连续选择 20 回合选项
3. 进度达到 100%，质量 ≥ 60%
4. 自动跳转到结算页
5. 显示胜利状态和职级
6. 成绩自动上传到后端
7. 查看排行榜能看到新记录

**验证**:
- [ ] 每回合事件正确显示
- [ ] 数值变化正确（上下限 0-100）
- [ ] 进度/质量达标时触发胜利
- [ ] 结算页显示正确的职级和分数
- [ ] 后端收到成绩数据

**场景 2: 现金耗尽失败**
1. 持续选择扣现金的选项
2. 现金降为 0 或负数
3. 游戏结束，跳转结算页
4. 显示"资金链断裂"

**验证**:
- [ ] 现金 ≤ 0 时触发失败
- [ ] 结算页显示失败原因
- [ ] 显示最终得分（可能很低）

**场景 3: 健康归零失败**
1. 持续选择扣健康的选项
2. 健康降为 0
3. 游戏结束

**验证**:
- [ ] 健康 ≤ 0 时触发失败
- [ ] 结算页显示"身体垮了"

**场景 4: 超时失败**
1. 消极选择，进度推进慢
2. 20 回合结束但进度未达标
3. 游戏结束

**验证**:
- [ ] 20 回合后自动结束
- [ ] 进度 < 100% 时判定为超时
- [ ] 显示"时间到了"

**场景 5: 再来一局**
1. 完成或失败后点击"再玩一次"
2. 游戏状态重置
3. 返回游戏页

**验证**:
- [ ] 状态完全重置（数值、事件历史）
- [ ] 新游戏正常运行
- [ ] 无旧数据残留

**场景 6: 查看排行榜**
1. 在首页或结算页点击"查看排行榜"
2. 排行榜页面显示真实数据
3. 可以看到自己的排名

**验证**:
- [ ] 排行榜显示真实玩家数据
- [ ] Tab 切换正常
- [ ] 显示"我的排名"

---

#### Task 3.2: 边界条件测试

**测试项**:

1. **数值边界**:
   - [ ] 现金/健康达到 100 时不再增加
   - [ ] 数值达到 0 时不再减少（除非触发失败）
   - [ ] 进度超过 100 时正确处理

2. **事件池**:
   - [ ] 60 张事件卡都能正常抽取
   - [ ] 同一事件不会短期内重复（机制正常）

3. **异常输入**:
   - [ ] 快速连续点击选项不会触发多次提交
   - [ ] 页面刷新时状态处理（可选）

---

### Batch 4: 性能优化

#### Task 4.1: 首屏加载优化

**目标**: 首次访问快速加载

**优化项**:

1. **代码分割** (如果需要):
   - 使用 React.lazy 懒加载页面组件
   - 路由级别的代码分割

2. **资源预加载**:
   - 预加载字体（如果有自定义字体）
   - 预连接到后端 API

3. **图片优化**:
   - 如果有图片，使用 WebP 格式
   - 添加适当的 width/height

4. **减少初始加载体积**:
   - 检查 vite build 输出大小
   - Tree-shaking 优化

**验证**:
- [ ] 首屏加载时间 < 2 秒（3G）
- [ ] Lighthouse 性能评分 > 80（可选）

---

#### Task 4.2: 运行时性能优化

**目标**: 游戏运行流畅

**优化项**:

1. **减少不必要的重渲染**:
   - 使用 React.memo 包装组件（如果需要）
   - Zustand store 订阅优化

2. **事件抽取代化**:
   - 可以提前加载下一张事件卡（可选）
   - 预生成随机数序列

3. **动画性能**:
   - 使用 CSS transform 和 opacity（GPU 加速）
   - 避免触发布局的属性

**验证**:
- [ ] 60fps 流畅运行
- [ ] 选项点击响应迅速
- [ ] 动画不卡顿

---

### Batch 5: Bug 修复和收尾

#### Task 5.1: 修复已知问题

**问题列表**:

1. **后端 UNIQUE 约束错误** (已在 Task 1.2 中处理)

2. **其他潜在问题**:
   - [ ] 签名验证失败时的错误提示
   - [ ] API 超时的处理
   - [ ] 网络错误时的友好提示

**修复方法**:
- 添加更详细的错误日志
- 改进错误消息
- 添加重试机制（可选）

---

#### Task 5.2: 文档完善

**文件**:
- `README.md` - 项目说明
- `frontend/README.md` - 前端说明
- `backend/README.md` - 后端说明

**内容**:
- 如何运行项目
- 项目结构说明
- API 文档
- 环境配置说明

---

### Batch 6: 可选功能（按需执行）

#### Task 6.1: Canvas 海报生成（如果时间允许）

**目标**: 玩家可以保存成绩单图片

**实现**:
- 使用 html2canvas 或 fabric.js
- 在结算页添加"保存成绩单"按钮
- 生成包含：职级、分数、净资产、项目履历的图片

---

#### Task 6.2: 数据埋点（如果时间允许）

**目标**: 收集用户行为数据

**实现**:
- 集成 Google Analytics 或其他埋点 SDK
- 追踪：页面访问、游戏开始、游戏结束、按钮点击
- 不收集个人敏感信息

---

## 验收清单（最终）

完成所有批次后，验证以下功能：

### 核心功能
- [ ] 从首页到游戏到结算的完整流程
- [ ] 4 种失败条件都能正确触发
- [ ] 胜利时显示正确的职级
- [ ] 再来一局功能正常

### 排行榜
- [ ] 显示真实玩家数据
- [ ] 支持 3 种排序方式
- [ ] 显示当前玩家排名
- [ ] 完成游戏后排行榜自动更新

### 移动端
- [ ] 在手机上可正常游玩
- [ ] 触摸交互流畅
- [ ] 布局适配合理

### 稳定性
- [ ] 无控制台错误
- [ ] API 调用成功率高
- [ ] 页面刷新后状态正确（可选）

---

## 执行顺序

1. **Batch 1: 排行榜数据集成** (关键)
2. **Batch 2: 移动端适配和优化** (重要)
3. **Batch 3: 完整游戏流程测试** (验证)
4. **Batch 4: 性能优化** (提升体验)
5. **Batch 5: Bug 修复和收尾** (完善)
6. **Batch 6: 可选功能** (锦上添花)

**预计时间**: 2-3 小时

---

## 备注

- 每完成一个 Batch，报告进度并等待反馈
- 遇到问题立即停止，不要强行推进
- 优先保证核心功能稳定，再考虑优化
- 保持代码质量，不要因为赶工而引入技术债
