# 关系系统重构设计方案

**设计日期**：2026-01-27
**设计目标**：将关系系统从"鸡肋"变为"与业绩同等重要的核心晋升维度"

---

## 一、设计理念

### 当前问题
- 关系不影响晋升（checkPromotion 不检查关系）
- 关系在事件中使用有限
- 维护成本高，收益低

### 解决方案
通过五大机制让关系变得至关重要：

1. **晋升硬性门槛**：每个职级需要特定核心关系达标
2. **专属维护方式**：每种关系 2 种维护方法，不同风险/收益
3. **负面事件触发**：关系低时随机负面事件，极低时功能限制
4. **经济收益解锁**：高关系解锁赚钱机会（每季度 5000+ 收益）
5. **特殊剧情事件**：高关系解锁专属事件（⭐ 标记）

---

## 二、晋升条件中的关系要求

### 核心设计
每个职级设定 1-2 个"核心关系"，晋升时这些关系必须达到最低要求。

### 具体方案

| 职级 | 核心关系 | 晋升要求 | 理由 |
|-----|---------|---------|------|
| 实习生 → 助理工程师 | 监理 | 60 | 实习生主要在工地配合监理工作 |
| 助理工程师 → 工程师 | 设计院 | 65 | 工程师需要对接设计变更 |
| 工程师 → 高级工程师 | 劳务队 | 70 | 高工需要管理劳务队伍 |
| 高级工程师 → 项目经理 | 甲方 + 监理 | 75 + 70 | 项目经理需要搞定甲乙双方 |
| 项目经理 → 项目总监 | 甲方 + 政府 | 80 + 70 | 总监级需要政府资源和甲方支持 |
| 项目总监 → 合伙人 | 所有关系 ≥ 75 | - | 合伙人需要全方位资源 |

### 实现方案

在 `shared/types/game.ts` 的 `RANK_CONFIGS` 中添加：

```typescript
relationshipRequirements?: {
  type: RelationshipType;
  minValue: number;
}[];
```

---

## 三、专属维护方式设计

### 设计原则
- 每种关系 2 种维护方式
- 符合行业特征
- 不同风险/收益组合
- 高能力/幸运提供加成

### 具体方案

#### 1. 甲方关系

**方式A：应酬宴请**（高风险高收益）
- 消耗：现金 2000 + 健康 -3
- 收益：甲方关系 +8-12（随机）
- 风险：15% 概率"过度应酬" → 健康 -8
- 加成：workAbility ≥ 50 → 收益 × 1.2

**方式B：项目汇报**（低风险稳健）
- 消耗：健康 -2
- 收益：甲方关系 +5-8（稳定）
- 加成：progress ≥ 50 → 收益 +2

---

#### 2. 设计院关系

**方式A：技术交流**（能力提升型）
- 消耗：健康 -2
- 收益：设计院关系 +6-10 + workAbility +1
- 特殊：workAbility ≥ 60 → 20% 获得"设计优化方案"
- 限制：health ≤ 30 无法参与

**方式B：图纸会审**（专业协作型）
- 消耗：健康 -3
- 收益：设计院关系 +4-7 + quality +1
- 特殊：10% 概率提前发现图纸问题 → progress +2
- 加成：workAbility ≥ 45 → 概率提升至 18%

---

#### 3. 劳务队关系

**方式A：现场慰问**（低成本日常维护）
- 消耗：现金 500
- 收益：劳务队关系 +5-8
- 加成：reputation ≥ 50 → 收益 × 1.3
- 风险：10% 概率"劳务纠纷" → 需支付 2000 或关系 -5

**方式B：解决纠纷**（危机处理型）
- 消耗：现金 0-3000（根据纠纷程度）
- 收益：劳务队关系 +8-15（关系越低收益越高）
- 触发条件：劳务队关系 ≤ 40 时可用
- 风险：50% 概率需要支付高额费用
- 加成：luck ≥ 50 → 高额费用概率降为 30%

---

#### 4. 监理关系

**方式A：礼品赠送**（高风险高收益）
- 消耗：现金 1000
- 收益：监理关系 +7-10
- 风险：20% 概率"廉政检查" → reputation -5，关系 -8
- 限制：连续 3 次使用收益递减
- 保护：luck ≥ 40 → 检查概率降为 10%

**方式B：配合验收**（工作型稳定）
- 消耗：健康 -2
- 收益：监理关系 +4-6 + quality +1
- 加成：workAbility ≥ 50 → 收益 × 1.3
- 特殊：15% 概率监理主动放水 → 下次验收自动通过

---

#### 5. 政府关系

**方式A：公关拜访**（赌博型极端收益）
- 消耗：现金 3000 + 健康 -4
- 收益：政府关系 +5-9
- 风险：30% 概率"大领导在家" → +15；否则 +3
- 加成：reputation ≥ 70 → 大领导概率 45%
- 惩罚：cash < 3000 → 关系 -10

**方式B：政策学习**（安全稳健型）
- 消耗：健康 -3
- 收益：政府关系 +4-7
- 加成：workAbility ≥ 55 → 收益 +2
- 特殊：workAbility ≥ 70 → 10% 获得"政策解读"（下次季度仓储费 -50%）

---

## 四、负面事件触发机制

### 4.1 关系低值负面事件（随机触发）

**触发时机**：每个季度结算时检查所有关系

| 关系值范围 | 触发概率 | 事件类型 | 影响 |
|----------|---------|---------|------|
| 40-49 | 25% | 轻度负面 | 单次小额损失 |
| 30-39 | 40% | 中度负面 | 关系进一步下降 + 资源损失 |
| 20-29 | 60% | 重度负面 | 多重损失 |
| 10-19 | 80% | 危机事件 | 严重影响游戏进程 |
| 0-9 | 100% | 灾难性 | 可能导致失败 |

### 具体事件设计

**甲方关系低事件**：
- 40分："甲方刁难" → progress -2，reputation -2
- 30分："工程款拖延" → cash -5000，甲方关系 -5
- 20分："甲方威胁停工" → progress -5，health -5
- 10分："被踢出项目" → reputation -15，cash -10000

**监理关系低事件**：
- 40分："监理挑刺" → quality -2，progress -1
- 30分："频繁返工" → cash -3000，progress -3
- 20分："停工整改" → progress -8，cash -8000
- 10分："吊销执业资格" → reputation -20，游戏结束警告

**设计院关系低事件**：
- 40分："图纸变更慢" → progress -2
- 30分："设计配合消极" → quality -2
- 20分："重大设计错误" → cash -10000，quality -5
- 10分："设计院断绝合作" → progress 停滞，强制降职

**劳务队关系低事件**：
- 40分："工人消极怠工" → progress -2，quality -1
- 30分："劳务罢工" → progress -5，cash -2000
- 20分："群体事件" → reputation -10，cash -5000
- 10分："劳务队集体离职" → 无法继续项目，游戏结束

**政府关系低事件**：
- 40分："检查增多" → health -3，progress -1
- 30分："行政处罚" → cash -5000，reputation -5
- 20分："项目被叫停" → progress -10，cash -15000
- 10分："被列入黑名单" → 游戏结束

---

### 4.2 关系极低功能限制

**触发条件**：任意关系 ≤ 15

| 关系类型 | 功能限制 | 解锁条件 |
|---------|---------|---------|
| 甲方 ≤ 15 | 无法获得新项目，现有项目收益 -50% | 甲方 > 15 |
| 监理 ≤ 15 | 工程验收自动失败，无法完成季度 | 监理 > 15 |
| 设计院 ≤ 15 | 无法提升 quality，工程质量锁定 | 设计院 > 15 |
| 劳务队 ≤ 15 | progress 增益减半，工人流失率 ×3 | 劳务队 > 15 |
| 政府 ≤ 15 | 每季度额外缴纳"罚款" 3000，无法晋升 | 政府 > 15 |

---

### 4.3 预警系统

- 关系 ≤ 50：提示"XX 关系紧张，建议维护"
- 关系 ≤ 30：红色警告"XX 关系危急，可能触发负面事件"
- 关系 ≤ 15：紧急警报"XX 关系崩溃，功能已受限"

---

## 五、高关系解锁赚钱机会

### 5.1 解锁机制

| 关系类型 | 解锁阈值 | 解锁内容 | 触发时机 |
|---------|---------|---------|---------|
| 甲方 | ≥ 75 | "甲方推荐项目" | 每季度 20% 概率 |
| 监理 | ≥ 70 | "验收快速通过奖金" | 每次季度结算 |
| 设计院 | ≥ 75 | "设计优化奖励" | 完成项目时 |
| 劳务队 | ≥ 70 | "劳务成本优惠" | 每季度结算 |
| 政府 | ≥ 80 | "政府补贴项目" | 每季度 15% 概率 |

---

### 5.2 具体赚钱机会

#### 甲方关系 ≥ 75：甲方推荐项目

每季度 20% 概率触发（≥90 时 35%）

```
【特殊事件】甲方王总找你
"小张啊，我朋友有个小项目，预算不多，但活儿简单。
这个项目我想交给你做，能帮的话就接下。"

选项 A：接下项目
- 收益：cash +8000~15000（随机）
- 消耗：health -3，progress +3
- 风险：10% 概率项目出问题 → reputation -5

选项 B：婉拒
- 甲方关系 -2
```

**加成**：workAbility ≥ 50 → 出问题概率降为 5%

---

#### 监理关系 ≥ 70：验收快速通过奖金

季度结算自动触发

```typescript
if (relationships.supervision >= 70) {
  const bonus = Math.floor(3000 + (relationships.supervision - 70) * 100);
  // 监理 70 分：+3000
  // 监理 100 分：+6000
  cash += bonus;
}
```

---

#### 设计院关系 ≥ 75：设计优化奖励

完成项目时触发

```
【特殊事件】设计院优化建议
"你这个项目我们可以优化一下，能省不少材料钱。"

选项 A：采纳优化方案
- 收益：下次项目材料成本 -30%
- 设计院关系 +2
```

**经济价值**：节省 1500-2400 材料

---

#### 劳务队关系 ≥ 70：劳务成本优惠

季度结算自动触发

```typescript
if (relationships.labor >= 70) {
  const discount = Math.floor((relationships.labor - 70) * 50);
  // 劳务 70 分：-0
  // 劳务 100 分：-1500
  cash += discount;
}
```

---

#### 政府关系 ≥ 80：政府补贴项目

每季度 15% 概率触发（≥90 时 25%）

```
【特殊事件】政府补贴通知
"恭喜！您的项目符合'绿色建筑补贴'政策，
政府决定给予专项资金支持。"

收益：cash +10000~20000（随机）
reputation +3
政府关系 +2
```

**加成**：reputation ≥ 70 → 补贴 × 1.2

---

### 5.3 组合效应示例

甲方 80 + 监理 75 + 劳务队 80：
- 验收奖金：+4500（监理 75）
- 劳务优惠：+500（劳务 80）
- 期望甲方项目：+2000 × 0.2 = +400
- **每季度期望收益：+5400**

---

## 六、高关系解锁特殊事件

### 6.1 解锁机制

| 关系类型 | 解锁阈值 | 事件数量 | 触发方式 |
|---------|---------|---------|---------|
| 甲方 | ≥ 80 | 3 个 | 事件阶段 15% 概率替代普通事件 |
| 监理 | ≥ 75 | 3 个 | 事件阶段 15% 概率替代普通事件 |
| 设计院 | ≥ 80 | 3 个 | 事件阶段 15% 概率替代普通事件 |
| 劳务队 | ≥ 75 | 3 个 | 事件阶段 15% 概率替代普通事件 |
| 政府 | ≥ 85 | 3 个 | 事件阶段 15% 概率替代普通事件 |

**特点**：
- ⭐ 标记特殊事件
- 剧情更丰富，多段对话
- 奖励更丰厚（5000-20000）
- 风险更高（部分有 riskFactor）
- 解锁隐藏选项

---

### 6.2 特殊事件示例

#### 甲方 ≥ 80：甲方的私人邀请

```
【⭐ 特殊事件】甲方的私人邀请
周末，甲方王总邀请你去他家打高尔夫。

选项 A：欣然前往
- 消耗：health -2，cash -500
- 收益：甲方关系 +8，cash +5000

选项 B：婉拒
- 甲方关系 -3

选项 C：🔧 高情商社交（需 workAbility ≥ 60）
- 收益：甲方关系 +12，reputation +5，cash +8000
```

---

#### 监理 ≥ 75：监理的默契

```
【⭐ 特殊事件】监理的默契
监理老李："这个隐蔽工程有些小问题，
但我可以睁一只眼闭一只眼，你看着办。"

选项 A：感谢理解，送点意思
- cash -2000
- 监理关系 +5，progress +3，quality -1

选项 B：坚持整改
- cash -3000
- quality +3，reputation +5

选项 C：🔧 专业说服（需 workAbility ≥ 55）
- quality +2，progress +2，监理关系 +5
```

---

#### 劳务队 ≥ 75：劳务队的忠诚

```
【⭐ 特殊事件】劳务队的忠诚
劳务队长老张："兄弟们愿意加班赶进度，不额外要钱。"

选项 A：请吃饭
- cash -1000
- 劳务队关系 +8，progress +5

选项 B：按规定发加班费
- cash -3000
- 劳务队关系 +10，reputation +5

选项 C：🎲 豪赌兄弟情（需 luck ≥ 45）
- riskFactor: 0.3
- 成功：progress +8，劳务队关系 +12
- 失败：劳务队关系 -5
```

---

## 七、实现任务清单

### 阶段一：类型定义和晋升条件
1. 修改 `shared/types/game.ts`：添加 `relationshipRequirements` 到 `RankConfig`
2. 修改 `RANK_CONFIGS`：为每个职级添加关系要求
3. 修改 `checkPromotion()`：添加关系检查逻辑
4. 添加关系不达标提示

### 阶段二：维护方式重构
5. 创建 `frontend/src/data/relationshipActions.ts`：定义 10 种维护方式
6. 修改 `StrategyPhase.tsx`：重构关系维护 UI（每种关系显示 2 种方式）
7. 实现维护方式的各种加成和风险机制

### 阶段三：负面事件系统
8. 创建 `frontend/src/data/relationshipNegativeEvents.ts`：定义 25 个负面事件
9. 修改 `quarterlySettlement()`：添加关系检查和负面事件触发
10. 添加功能限制逻辑（关系 ≤ 15）
11. 添加预警提示

### 阶段四：经济收益系统
12. 修改 `quarterlySettlement()`：添加监理奖金和劳务优惠计算
13. 创建 5 个赚钱机会特殊事件
14. 在事件系统中集成赚钱机会触发

### 阶段五：特殊剧情事件
15. 创建 15 个特殊事件（每种关系 3 个）
16. 修改 `selectRandomEvent()`：添加特殊事件优先触发逻辑
17. 添加 ⭐ 标记显示

### 阶段六：测试和文档
18. 测试所有关系维护方式
19. 测试负面事件触发
20. 测试经济收益计算
21. 测试特殊事件触发
22. 更新 `docs/GAME_DESIGN_DOCUMENT.md`

---

## 八、设计原则回顾

1. **关系类型差异化**：每种关系有专属维护方式
2. **风险-收益平衡**：高收益伴随高风险
3. **符合行业特征**：应酬→甲方、技术交流→设计院等
4. **职级特定**：每个职级有核心关系要求
5. **YAGNI**：只实现设计的内容，不添加额外功能
6. **TDD**：先写测试，再实现功能
